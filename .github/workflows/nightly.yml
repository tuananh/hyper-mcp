name: Nightly Release

on:
  schedule:
    - cron: '0 17 * * *' # midnight GMT+7
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-oci-images:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      packages: write
      id-token: write # needed for keyless signing
    
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Install cosign
        uses: sigstore/cosign-installer@d58896d6a1865668819e1d91763c7751a165e159 # v3.9.2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to DockerHub Registry
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push hyper-mcp
        run: |
          echo "Building hyper-mcp image"
          ghcr_image="ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly-${{ matrix.arch }}"
          dockerhub_image="docker.io/tuananh/hyper-mcp:nightly-${{ matrix.arch }}"
          docker build -t $ghcr_image -t $dockerhub_image .

          docker push $ghcr_image
          docker push $dockerhub_image

          cosign sign --yes $ghcr_image
          cosign sign --yes $dockerhub_image

      # we dont need to build multi-arch plugin images as they are wasm32-wasip1
      # so we can just build amd64 and push it to the registry
      - name: Build and push plugin images
        if: matrix.arch == 'amd64'
        run: |
          for plugin in examples/plugins/*/; do
            plugin_name=$(basename $plugin)
            echo "Building plugin: $plugin_name"
            
            image_name="ghcr.io/${{ github.repository_owner }}/${plugin_name}-plugin:nightly"
            docker build -t $image_name $plugin
            docker push $image_name
            
            cosign sign --yes $image_name
          done

  # do this before we build nightly binaries
  prepare-nightly-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Set nightly tag to latest main
        run: |
          git fetch origin main
          git tag -f nightly origin/main
          git push -f origin nightly

      - name: Delete existing nightly release
        run: gh release delete nightly --yes || true

  build-nightly-binaries:
    needs: prepare-nightly-release
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            ext: ""
          - os: ubuntu-24.04-arm
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            ext: ""
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin
            ext: ""
          - os: windows-latest
            arch: x86_64
            target: x86_64-pc-windows-msvc
            ext: ".exe"

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - run: cargo install cargo-auditable

      - name: Install compilation targets
        run: rustup target add ${{ matrix.target }}

      - name: Build
        run: cargo auditable build --target ${{ matrix.target }} --release
 
      - name: Install zip (Windows only)
        if: runner.os == 'Windows'
        run: choco install zip -y

      - name: Create archives and checksums
        shell: bash
        run: |
          mkdir -p dist/${{ matrix.target }}

          bin_name="hyper-mcp${{ matrix.ext }}"
          cp target/${{ matrix.target }}/release/$bin_name dist/${{ matrix.target }}/

          cd dist/${{ matrix.target }}
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            zip ../hyper-mcp-${{ matrix.target }}.zip $bin_name
          else
            tar -czf ../hyper-mcp-${{ matrix.target }}.tar.gz $bin_name
          fi
          cd ..

          {
            if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
              file="hyper-mcp-${{ matrix.target }}.zip"
            else
              file="hyper-mcp-${{ matrix.target }}.tar.gz"
            fi
            echo "$file:"
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum $file
            else
              shasum -a 256 $file
            fi
          } > checksums-${{ matrix.target }}.txt

      - name: Create new nightly release
        id: create_release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2.3.3
        with:
          tag_name: nightly
          name: Nightly build
          draft: false
          prerelease: true
          files: |
            dist/hyper-mcp-${{ matrix.target }}.tar.gz
            dist/hyper-mcp-${{ matrix.target }}.zip
            dist/checksums-${{ matrix.target }}.txt
          body: |
            Nightly build from `main` branch.
            
            This release includes:
            - hyper-mcp binaries for Linux & macOS
            - hyper-mcp container image: `ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly`
            - Plugin images: `ghcr.io/${{ github.repository_owner }}/<plugin-name>-plugin:nightly`
            
            All container images are signed with Cosign. Verify the image like this:
            ```bash
            cosign verify \
              --certificate-identity "https://github.com/tuananh/hyper-mcp/.github/workflows/nightly.yml@refs/heads/main" \
              --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
              ghcr.io/tuananh/hyper-mcp:nightly
            ```

  create-multiarch-manifests:
    needs: build-oci-images
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write # needed for keyless signing
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Install cosign
        uses: sigstore/cosign-installer@d58896d6a1865668819e1d91763c7751a165e159 # v3.9.2
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to DockerHub Registry
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          
      - name: Create and push multi-arch nightly tags
        run: |
          # Main image
          docker buildx imagetools create \
            -t ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly \
            ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly-amd64 \
            ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly-arm64

          cosign sign --yes ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly

          # DockerHub
          docker buildx imagetools create \
            -t tuananh/hyper-mcp:nightly \
            tuananh/hyper-mcp:nightly-amd64 \
            tuananh/hyper-mcp:nightly-arm64

          cosign sign --yes tuananh/hyper-mcp:nightly
